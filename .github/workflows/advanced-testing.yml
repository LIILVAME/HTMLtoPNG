name: ğŸ§ª Tests AvancÃ©s et Monitoring

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Tests automatiques tous les jours Ã  2h du matin
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  integration-tests:
    name: ğŸ”— Tests d'IntÃ©gration
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸŒ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ”§ Installation des dÃ©pendances de test
        run: |
          npm install -g playwright
          npm install -g lighthouse
          npm install -g axe-core

      - name: ğŸš€ DÃ©marrage du serveur de test
        run: |
          python3 -m http.server 8080 &
          sleep 5
        
      - name: ğŸ§ª Tests d'intÃ©gration E2E
        run: |
          echo "ğŸ” Test de chargement de la page principale"
          curl -f http://localhost:8080/ || exit 1
          
          echo "ğŸ” Test de prÃ©sence des Ã©lÃ©ments critiques"
          curl -s http://localhost:8080/ | grep -q "HTML to PNG" || exit 1
          curl -s http://localhost:8080/ | grep -q "convertBtn" || exit 1
          curl -s http://localhost:8080/ | grep -q "htmlInput" || exit 1
          
          echo "ğŸ” Test de chargement des scripts"
          curl -f http://localhost:8080/script.js || exit 1
          curl -f http://localhost:8080/social-share.js || exit 1
          
          echo "ğŸ” Test de chargement des styles"
          curl -f http://localhost:8080/styles.css || exit 1
          
          echo "âœ… Tous les tests d'intÃ©gration passÃ©s"

  performance-tests:
    name: âš¡ Tests de Performance
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸŒ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ”§ Installation de Lighthouse
        run: npm install -g lighthouse

      - name: ğŸš€ DÃ©marrage du serveur
        run: |
          python3 -m http.server 8080 &
          sleep 5

      - name: âš¡ Audit de performance Lighthouse
        run: |
          echo "ğŸ” Analyse des performances avec Lighthouse"
          lighthouse http://localhost:8080 --output=json --output-path=./lighthouse-report.json --chrome-flags="--headless --no-sandbox" || true
          
          echo "ğŸ“Š VÃ©rification des mÃ©triques de performance"
          if [ -f lighthouse-report.json ]; then
            echo "âœ… Rapport Lighthouse gÃ©nÃ©rÃ© avec succÃ¨s"
            # Extraction des mÃ©triques principales
            node -e "const report = JSON.parse(require('fs').readFileSync('lighthouse-report.json')); console.log('Performance Score:', report.lhr.categories.performance.score * 100); console.log('Accessibility Score:', report.lhr.categories.accessibility.score * 100);"
          else
            echo "âš ï¸ Impossible de gÃ©nÃ©rer le rapport Lighthouse"
          fi

      - name: ğŸ“ˆ Test de taille des fichiers
        run: |
          echo "ğŸ“ VÃ©rification de la taille des assets"
          
          # VÃ©rification que les fichiers ne sont pas trop volumineux
          MAX_SIZE=500000  # 500KB
          
          for file in *.js *.css *.html; do
            if [ -f "$file" ]; then
              size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
              echo "ğŸ“„ $file: ${size} bytes"
              if [ $size -gt $MAX_SIZE ]; then
                echo "âš ï¸ Attention: $file dÃ©passe la taille recommandÃ©e (${size} > ${MAX_SIZE})"
              fi
            fi
          done
          
          echo "âœ… VÃ©rification des tailles terminÃ©e"

  browser-compatibility:
    name: ğŸŒ Tests de CompatibilitÃ© Navigateur
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸš€ DÃ©marrage du serveur
        run: |
          python3 -m http.server 8080 &
          sleep 5

      - name: ğŸŒ Test de compatibilitÃ© HTML5
        run: |
          echo "ğŸ” VÃ©rification de la compatibilitÃ© HTML5"
          
          # VÃ©rification des balises HTML5 modernes
          curl -s http://localhost:8080/ | grep -q "<!DOCTYPE html>" || exit 1
          curl -s http://localhost:8080/ | grep -q "<meta charset=" || exit 1
          curl -s http://localhost:8080/ | grep -q "<meta name=\"viewport\"" || exit 1
          
          echo "âœ… Structure HTML5 valide"

      - name: ğŸ“± Test de responsive design
        run: |
          echo "ğŸ“± VÃ©rification du design responsive"
          
          # VÃ©rification de la prÃ©sence de media queries
          if curl -s http://localhost:8080/styles.css | grep -q "@media"; then
            echo "âœ… Media queries dÃ©tectÃ©es"
          else
            echo "âš ï¸ Aucune media query trouvÃ©e"
          fi
          
          # VÃ©rification du viewport
          if curl -s http://localhost:8080/ | grep -q "viewport"; then
            echo "âœ… Balise viewport prÃ©sente"
          else
            echo "âŒ Balise viewport manquante"
            exit 1
          fi

  accessibility-audit:
    name: â™¿ Audit d'AccessibilitÃ©
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸš€ DÃ©marrage du serveur
        run: |
          python3 -m http.server 8080 &
          sleep 5

      - name: â™¿ Tests d'accessibilitÃ©
        run: |
          echo "â™¿ VÃ©rification de l'accessibilitÃ©"
          
          # VÃ©rification des attributs alt pour les images
          html_content=$(curl -s http://localhost:8080/)
          
          # Test des labels pour les formulaires
          if echo "$html_content" | grep -q "<label"; then
            echo "âœ… Labels de formulaire dÃ©tectÃ©s"
          else
            echo "âš ï¸ Aucun label de formulaire trouvÃ©"
          fi
          
          # Test des attributs aria
          if echo "$html_content" | grep -q "aria-"; then
            echo "âœ… Attributs ARIA dÃ©tectÃ©s"
          else
            echo "âš ï¸ Aucun attribut ARIA trouvÃ©"
          fi
          
          # Test du contraste (basique)
          if curl -s http://localhost:8080/styles.css | grep -q "color:"; then
            echo "âœ… Styles de couleur dÃ©finis"
          fi
          
          echo "âœ… Audit d'accessibilitÃ© terminÃ©"

  monitoring-setup:
    name: ğŸ“Š Configuration du Monitoring
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ“Š GÃ©nÃ©ration du rapport de monitoring
        run: |
          echo "ğŸ“Š GÃ©nÃ©ration du rapport de monitoring"
          
          # CrÃ©ation d'un rapport de santÃ© du projet
          cat > monitoring-report.md << EOF
          # ğŸ“Š Rapport de Monitoring - $(date)
          
          ## ğŸ¯ MÃ©triques du Projet
          
          ### ğŸ“ Structure des Fichiers
          - **Fichiers HTML**: $(find . -name "*.html" | wc -l)
          - **Fichiers JavaScript**: $(find . -name "*.js" | wc -l)
          - **Fichiers CSS**: $(find . -name "*.css" | wc -l)
          - **Fichiers de configuration**: $(find . -name "*.json" -o -name "*.yml" -o -name "*.yaml" | wc -l)
          
          ### ğŸ“ Taille du Projet
          - **Taille totale**: $(du -sh . | cut -f1)
          - **Nombre de lignes de code**: $(find . -name "*.js" -o -name "*.css" -o -name "*.html" | xargs wc -l | tail -1)
          
          ### ğŸ”§ Configuration
          - **Workflow GitHub Actions**: âœ… ConfigurÃ©
          - **DÃ©ploiement automatique**: âœ… Actif
          - **Tests automatisÃ©s**: âœ… ConfigurÃ©
          
          ### ğŸ“ˆ Statut des Tests
          - **Tests d'intÃ©gration**: En cours...
          - **Tests de performance**: En cours...
          - **Tests de compatibilitÃ©**: En cours...
          - **Audit d'accessibilitÃ©**: En cours...
          
          ---
          *Rapport gÃ©nÃ©rÃ© automatiquement le $(date)*
          EOF
          
          echo "âœ… Rapport de monitoring gÃ©nÃ©rÃ©"
          
      - name: ğŸ“¤ Upload du rapport
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-report
          path: monitoring-report.md
          retention-days: 30

  notification:
    name: ğŸ“§ Notifications
    runs-on: ubuntu-latest
    needs: [integration-tests, performance-tests, browser-compatibility, accessibility-audit]
    if: always()
    steps:
      - name: ğŸ“§ RÃ©sumÃ© des tests
        run: |
          echo "ğŸ“§ GÃ©nÃ©ration du rÃ©sumÃ© des tests avancÃ©s"
          
          # Statut des jobs
          INTEGRATION_STATUS="${{ needs.integration-tests.result }}"
          PERFORMANCE_STATUS="${{ needs.performance-tests.result }}"
          COMPATIBILITY_STATUS="${{ needs.browser-compatibility.result }}"
          ACCESSIBILITY_STATUS="${{ needs.accessibility-audit.result }}"
          
          echo "ğŸ”— Tests d'intÃ©gration: $INTEGRATION_STATUS"
          echo "âš¡ Tests de performance: $PERFORMANCE_STATUS"
          echo "ğŸŒ Tests de compatibilitÃ©: $COMPATIBILITY_STATUS"
          echo "â™¿ Audit d'accessibilitÃ©: $ACCESSIBILITY_STATUS"
          
          # DÃ©termination du statut global
          if [[ "$INTEGRATION_STATUS" == "success" && "$PERFORMANCE_STATUS" == "success" && "$COMPATIBILITY_STATUS" == "success" && "$ACCESSIBILITY_STATUS" == "success" ]]; then
            echo "âœ… Tous les tests avancÃ©s ont rÃ©ussi!"
            echo "ğŸš€ Le projet est prÃªt pour la production"
          else
            echo "âš ï¸ Certains tests ont Ã©chouÃ© ou ont Ã©tÃ© ignorÃ©s"
            echo "ğŸ” VÃ©rifiez les logs pour plus de dÃ©tails"
          fi