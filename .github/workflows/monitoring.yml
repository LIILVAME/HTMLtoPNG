name: ðŸ“Š Monitoring et Alertes AvancÃ©es

on:
  schedule:
    # Monitoring quotidien Ã  6h du matin
    - cron: '0 6 * * *'
    # Monitoring hebdomadaire le dimanche Ã  minuit
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      monitoring_type:
        description: 'Type de monitoring'
        required: true
        default: 'complet'
        type: choice
        options:
        - complet
        - performance
        - securite
        - disponibilite

jobs:
  health-check:
    name: ðŸ¥ VÃ©rification de SantÃ©
    runs-on: ubuntu-latest
    outputs:
      site_status: ${{ steps.check.outputs.status }}
      response_time: ${{ steps.check.outputs.response_time }}
    steps:
      - name: ðŸŒ Test de disponibilitÃ© du site
        id: check
        run: |
          echo "ðŸŒ VÃ©rification de la disponibilitÃ© du site"
          
          SITE_URL="https://liilvame.github.io/HTMLtoPNG/"
          
          # Test de disponibilitÃ© avec mesure du temps de rÃ©ponse
          start_time=$(date +%s%N)
          
          if curl -f -s -o /dev/null -w "%{http_code}" "$SITE_URL" | grep -q "200"; then
            end_time=$(date +%s%N)
            response_time=$(( (end_time - start_time) / 1000000 ))
            
            echo "âœ… Site accessible"
            echo "â±ï¸ Temps de rÃ©ponse: ${response_time}ms"
            echo "status=up" >> $GITHUB_OUTPUT
            echo "response_time=${response_time}" >> $GITHUB_OUTPUT
            
            # VÃ©rification du contenu
            content=$(curl -s "$SITE_URL")
            if echo "$content" | grep -q "HTML to PNG"; then
              echo "âœ… Contenu principal dÃ©tectÃ©"
            else
              echo "âš ï¸ Contenu principal non dÃ©tectÃ©"
            fi
            
          else
            echo "âŒ Site inaccessible"
            echo "status=down" >> $GITHUB_OUTPUT
            echo "response_time=0" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ” Test des fonctionnalitÃ©s critiques
        run: |
          echo "ðŸ” Test des fonctionnalitÃ©s critiques"
          
          SITE_URL="https://liilvame.github.io/HTMLtoPNG/"
          
          # RÃ©cupÃ©ration du contenu de la page
          content=$(curl -s "$SITE_URL")
          
          # Test de prÃ©sence des Ã©lÃ©ments critiques
          critical_elements=(
            "convertBtn"
            "htmlInput"
            "downloadBtn"
            "script.js"
            "styles.css"
          )
          
          for element in "${critical_elements[@]}"; do
            if echo "$content" | grep -q "$element"; then
              echo "âœ… Ã‰lÃ©ment critique '$element' prÃ©sent"
            else
              echo "âŒ Ã‰lÃ©ment critique '$element' manquant"
            fi
          done

  performance-monitoring:
    name: âš¡ Monitoring des Performances
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.site_status == 'up'
    steps:
      - name: ðŸŒ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ”§ Installation de Lighthouse
        run: npm install -g lighthouse

      - name: âš¡ Audit de performance Lighthouse
        run: |
          echo "âš¡ Audit de performance avec Lighthouse"
          
          SITE_URL="https://liilvame.github.io/HTMLtoPNG/"
          
          # ExÃ©cution de Lighthouse
          lighthouse "$SITE_URL" \
            --output=json \
            --output-path=./lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox" \
            --quiet || true
          
          if [ -f lighthouse-report.json ]; then
            echo "ðŸ“Š Extraction des mÃ©triques de performance"
            
            # Extraction des scores principaux
            performance_score=$(node -e "const report = JSON.parse(require('fs').readFileSync('lighthouse-report.json')); console.log(Math.round(report.lhr.categories.performance.score * 100));")
            accessibility_score=$(node -e "const report = JSON.parse(require('fs').readFileSync('lighthouse-report.json')); console.log(Math.round(report.lhr.categories.accessibility.score * 100));")
            best_practices_score=$(node -e "const report = JSON.parse(require('fs').readFileSync('lighthouse-report.json')); console.log(Math.round(report.lhr.categories['best-practices'].score * 100));")
            seo_score=$(node -e "const report = JSON.parse(require('fs').readFileSync('lighthouse-report.json')); console.log(Math.round(report.lhr.categories.seo.score * 100));")
            
            echo "ðŸ“ˆ Scores Lighthouse:"
            echo "  - Performance: ${performance_score}/100"
            echo "  - AccessibilitÃ©: ${accessibility_score}/100"
            echo "  - Bonnes pratiques: ${best_practices_score}/100"
            echo "  - SEO: ${seo_score}/100"
            
            # Alertes si les scores sont trop bas
            if [ $performance_score -lt 80 ]; then
              echo "âš ï¸ ALERTE: Score de performance faible ($performance_score/100)"
            fi
            
            if [ $accessibility_score -lt 90 ]; then
              echo "âš ï¸ ALERTE: Score d'accessibilitÃ© faible ($accessibility_score/100)"
            fi
            
            # Extraction des mÃ©triques Core Web Vitals
            echo "ðŸŽ¯ Core Web Vitals:"
            node -e "
              const report = JSON.parse(require('fs').readFileSync('lighthouse-report.json'));
              const audits = report.lhr.audits;
              
              const fcp = audits['first-contentful-paint']?.displayValue || 'N/A';
              const lcp = audits['largest-contentful-paint']?.displayValue || 'N/A';
              const cls = audits['cumulative-layout-shift']?.displayValue || 'N/A';
              const fid = audits['max-potential-fid']?.displayValue || 'N/A';
              
              console.log('  - First Contentful Paint:', fcp);
              console.log('  - Largest Contentful Paint:', lcp);
              console.log('  - Cumulative Layout Shift:', cls);
              console.log('  - First Input Delay:', fid);
            "
            
          else
            echo "âŒ Impossible de gÃ©nÃ©rer le rapport Lighthouse"
          fi

      - name: ðŸ“¤ Upload du rapport Lighthouse
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: lighthouse-report.json
          retention-days: 30

  security-monitoring:
    name: ðŸ”’ Monitoring de SÃ©curitÃ©
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ”’ Audit de sÃ©curitÃ© avancÃ©
        run: |
          echo "ðŸ”’ Audit de sÃ©curitÃ© avancÃ©"
          
          # VÃ©rification des en-tÃªtes de sÃ©curitÃ©
          SITE_URL="https://liilvame.github.io/HTMLtoPNG/"
          
          echo "ðŸ” VÃ©rification des en-tÃªtes de sÃ©curitÃ©"
          headers=$(curl -s -I "$SITE_URL")
          
          # VÃ©rification des en-tÃªtes de sÃ©curitÃ© importants
          security_headers=(
            "X-Frame-Options"
            "X-Content-Type-Options"
            "Referrer-Policy"
            "Content-Security-Policy"
          )
          
          for header in "${security_headers[@]}"; do
            if echo "$headers" | grep -qi "$header"; then
              echo "âœ… En-tÃªte de sÃ©curitÃ© '$header' prÃ©sent"
            else
              echo "âš ï¸ En-tÃªte de sÃ©curitÃ© '$header' manquant"
            fi
          done

      - name: ðŸ” Scan des vulnÃ©rabilitÃ©s dans le code
        run: |
          echo "ðŸ” Scan des vulnÃ©rabilitÃ©s dans le code"
          
          # Recherche de patterns de sÃ©curitÃ© problÃ©matiques
          echo "ðŸ” Recherche de patterns dangereux..."
          
          # VÃ©rification des scripts inline
          if grep -r "javascript:" *.html 2>/dev/null; then
            echo "âš ï¸ Scripts javascript: dÃ©tectÃ©s dans le HTML"
          else
            echo "âœ… Aucun script javascript: dÃ©tectÃ©"
          fi
          
          # VÃ©rification des eval()
          if grep -r "eval(" *.js 2>/dev/null; then
            echo "âš ï¸ Utilisation d'eval() dÃ©tectÃ©e"
          else
            echo "âœ… Aucune utilisation d'eval() dÃ©tectÃ©e"
          fi
          
          # VÃ©rification des innerHTML sans sanitization
          if grep -r "innerHTML" *.js 2>/dev/null; then
            echo "âš ï¸ Utilisation d'innerHTML dÃ©tectÃ©e - vÃ©rifier la sanitization"
          else
            echo "âœ… Aucune utilisation d'innerHTML dÃ©tectÃ©e"
          fi
          
          # VÃ©rification des clÃ©s API ou secrets
          secret_patterns=(
            "api[_-]?key"
            "secret"
            "password"
            "token"
            "auth"
          )
          
          for pattern in "${secret_patterns[@]}"; do
            if grep -ri "$pattern" *.js *.html *.css 2>/dev/null | grep -v "placeholder" | grep -v "example"; then
              echo "âš ï¸ Possible secret dÃ©tectÃ© avec le pattern '$pattern'"
            fi
          done

  uptime-monitoring:
    name: â° Monitoring de DisponibilitÃ©
    runs-on: ubuntu-latest
    steps:
      - name: â° Test de disponibilitÃ© sur 24h
        run: |
          echo "â° Simulation de monitoring de disponibilitÃ©"
          
          SITE_URL="https://liilvame.github.io/HTMLtoPNG/"
          
          # Test de disponibilitÃ© multiple
          success_count=0
          total_tests=5
          total_response_time=0
          
          for i in $(seq 1 $total_tests); do
            echo "ðŸ” Test $i/$total_tests"
            
            start_time=$(date +%s%N)
            
            if curl -f -s -o /dev/null "$SITE_URL"; then
              end_time=$(date +%s%N)
              response_time=$(( (end_time - start_time) / 1000000 ))
              
              echo "  âœ… SuccÃ¨s - ${response_time}ms"
              success_count=$((success_count + 1))
              total_response_time=$((total_response_time + response_time))
            else
              echo "  âŒ Ã‰chec"
            fi
            
            # Attendre 10 secondes entre les tests
            sleep 10
          done
          
          # Calcul des statistiques
          uptime_percentage=$((success_count * 100 / total_tests))
          
          if [ $success_count -gt 0 ]; then
            avg_response_time=$((total_response_time / success_count))
          else
            avg_response_time=0
          fi
          
          echo "ðŸ“Š Statistiques de disponibilitÃ©:"
          echo "  - Uptime: ${uptime_percentage}% (${success_count}/${total_tests})"
          echo "  - Temps de rÃ©ponse moyen: ${avg_response_time}ms"
          
          # Alertes
          if [ $uptime_percentage -lt 100 ]; then
            echo "âš ï¸ ALERTE: DisponibilitÃ© rÃ©duite (${uptime_percentage}%)"
          fi
          
          if [ $avg_response_time -gt 3000 ]; then
            echo "âš ï¸ ALERTE: Temps de rÃ©ponse Ã©levÃ© (${avg_response_time}ms)"
          fi

  report-generation:
    name: ðŸ“Š GÃ©nÃ©ration de Rapport
    runs-on: ubuntu-latest
    needs: [health-check, performance-monitoring, security-monitoring, uptime-monitoring]
    if: always()
    steps:
      - name: ðŸ“Š GÃ©nÃ©ration du rapport de monitoring
        run: |
          echo "ðŸ“Š GÃ©nÃ©ration du rapport de monitoring complet"
          
          # RÃ©cupÃ©ration des statuts
          HEALTH_STATUS="${{ needs.health-check.result }}"
          PERFORMANCE_STATUS="${{ needs.performance-monitoring.result }}"
          SECURITY_STATUS="${{ needs.security-monitoring.result }}"
          UPTIME_STATUS="${{ needs.uptime-monitoring.result }}"
          
          SITE_STATUS="${{ needs.health-check.outputs.site_status }}"
          RESPONSE_TIME="${{ needs.health-check.outputs.response_time }}"
          
          # GÃ©nÃ©ration du rapport
          cat > monitoring-report.md << EOF
          # ðŸ“Š Rapport de Monitoring - $(date)
          
          ## ðŸŽ¯ RÃ©sumÃ© ExÃ©cutif
          
          **Statut global**: $([ "$HEALTH_STATUS" = "success" ] && echo "ðŸŸ¢ OpÃ©rationnel" || echo "ðŸ”´ ProblÃ¨me dÃ©tectÃ©")
          **Site web**: $([ "$SITE_STATUS" = "up" ] && echo "ðŸŸ¢ En ligne" || echo "ðŸ”´ Hors ligne")
          **Temps de rÃ©ponse**: ${RESPONSE_TIME}ms
          
          ## ðŸ“‹ DÃ©tail des VÃ©rifications
          
          ### ðŸ¥ SantÃ© du Site
          - **Statut**: $HEALTH_STATUS
          - **DisponibilitÃ©**: $SITE_STATUS
          - **Temps de rÃ©ponse**: ${RESPONSE_TIME}ms
          
          ### âš¡ Performances
          - **Statut**: $PERFORMANCE_STATUS
          - **Audit Lighthouse**: $([ "$PERFORMANCE_STATUS" = "success" ] && echo "âœ… ComplÃ©tÃ©" || echo "âŒ Ã‰chec")
          
          ### ðŸ”’ SÃ©curitÃ©
          - **Statut**: $SECURITY_STATUS
          - **Audit de sÃ©curitÃ©**: $([ "$SECURITY_STATUS" = "success" ] && echo "âœ… ComplÃ©tÃ©" || echo "âŒ Ã‰chec")
          
          ### â° DisponibilitÃ©
          - **Statut**: $UPTIME_STATUS
          - **Tests de disponibilitÃ©**: $([ "$UPTIME_STATUS" = "success" ] && echo "âœ… ComplÃ©tÃ©s" || echo "âŒ Ã‰chec")
          
          ## ðŸš¨ Alertes et Recommandations
          
          $(if [ "$HEALTH_STATUS" != "success" ] || [ "$SITE_STATUS" != "up" ]; then
            echo "### ðŸ”´ Alertes Critiques"
            echo "- Site inaccessible ou problÃ¨me de santÃ© dÃ©tectÃ©"
            echo "- Action immÃ©diate requise"
            echo ""
          fi)
          
          $(if [ "$RESPONSE_TIME" -gt 2000 ] 2>/dev/null; then
            echo "### âš ï¸ Alertes de Performance"
            echo "- Temps de rÃ©ponse Ã©levÃ© (${RESPONSE_TIME}ms > 2000ms)"
            echo "- Optimisation recommandÃ©e"
            echo ""
          fi)
          
          ## ðŸ“ˆ Tendances
          
          - **Monitoring quotidien**: Actif
          - **Historique**: Consultez les artifacts des exÃ©cutions prÃ©cÃ©dentes
          - **Prochaine vÃ©rification**: $(date -d '+1 day' '+%Y-%m-%d %H:%M')
          
          ## ðŸ”§ Actions RecommandÃ©es
          
          1. **Surveillance continue**: Maintenir le monitoring automatique
          2. **Optimisation**: Consulter les rapports Lighthouse pour les amÃ©liorations
          3. **SÃ©curitÃ©**: ImplÃ©menter les en-tÃªtes de sÃ©curitÃ© manquants
          4. **Performance**: Optimiser les assets si nÃ©cessaire
          
          ---
          
          **Rapport gÃ©nÃ©rÃ© automatiquement le $(date)**
          **Workflow**: ${{ github.workflow }}
          **Run ID**: ${{ github.run_id }}
          EOF
          
          echo "âœ… Rapport de monitoring gÃ©nÃ©rÃ©"

      - name: ðŸ“¤ Upload du rapport de monitoring
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-report-$(date +%Y%m%d)
          path: monitoring-report.md
          retention-days: 90

  alerting:
    name: ðŸš¨ SystÃ¨me d'Alertes
    runs-on: ubuntu-latest
    needs: [health-check, performance-monitoring, security-monitoring, uptime-monitoring]
    if: failure() || needs.health-check.outputs.site_status == 'down'
    steps:
      - name: ðŸš¨ GÃ©nÃ©ration d'alerte critique
        run: |
          echo "ðŸš¨ ALERTE CRITIQUE DÃ‰TECTÃ‰E"
          
          SITE_STATUS="${{ needs.health-check.outputs.site_status }}"
          
          if [ "$SITE_STATUS" = "down" ]; then
            echo "âŒ SITE HORS LIGNE"
            echo "ðŸ” Le site https://liilvame.github.io/HTMLtoPNG/ est inaccessible"
            echo "â° DÃ©tectÃ© le: $(date)"
            echo "ðŸš¨ Action immÃ©diate requise"
          fi
          
          # Ici, vous pourriez intÃ©grer avec des services d'alerte comme:
          # - Slack
          # - Discord
          # - Email
          # - SMS
          # - PagerDuty
          
          echo "ðŸ“§ Notification d'alerte envoyÃ©e (simulation)"

      - name: ðŸ“ Log de l'incident
        run: |
          echo "ðŸ“ Enregistrement de l'incident"
          
          cat > incident-log.md << EOF
          # ðŸš¨ Log d'Incident - $(date)
          
          ## ðŸ“‹ DÃ©tails de l'Incident
          
          **Heure de dÃ©tection**: $(date)
          **Type**: ProblÃ¨me de disponibilitÃ©/performance
          **SÃ©vÃ©ritÃ©**: Critique
          
          ## ðŸ” Diagnostic
          
          - **Statut du site**: ${{ needs.health-check.outputs.site_status }}
          - **Temps de rÃ©ponse**: ${{ needs.health-check.outputs.response_time }}ms
          
          ## ðŸ› ï¸ Actions Ã  Entreprendre
          
          1. VÃ©rifier l'Ã©tat de GitHub Pages
          2. ContrÃ´ler les logs de dÃ©ploiement
          3. Tester la connectivitÃ© rÃ©seau
          4. VÃ©rifier la configuration DNS
          
          ## ðŸ“ž Contacts d'Urgence
          
          - Ã‰quipe DevOps: [Contact]
          - Administrateur systÃ¨me: [Contact]
          
          ---
          
          **Incident ID**: ${{ github.run_id }}
          **Workflow**: ${{ github.workflow }}
          EOF
          
          echo "âœ… Log d'incident crÃ©Ã©"

      - name: ðŸ“¤ Upload du log d'incident
        uses: actions/upload-artifact@v4
        with:
          name: incident-log-$(date +%Y%m%d-%H%M%S)
          path: incident-log.md
          retention-days: 365