name: üöÄ Optimisation des Assets

on:
  push:
    branches: [ main ]
    paths:
      - '**.js'
      - '**.css'
      - '**.html'
      - '**.png'
      - '**.jpg'
      - '**.jpeg'
      - '**.svg'
  workflow_dispatch:

jobs:
  asset-optimization:
    name: üì¶ Optimisation des Assets
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üåê Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üîß Installation des outils d'optimisation
        run: |
          npm install -g terser
          npm install -g csso-cli
          npm install -g html-minifier-terser
          sudo apt-get update
          sudo apt-get install -y optipng jpegoptim

      - name: üìÅ Cr√©ation du dossier optimis√©
        run: |
          mkdir -p optimized
          cp -r * optimized/ 2>/dev/null || true
          cd optimized
          rm -rf .git .github node_modules 2>/dev/null || true

      - name: üóúÔ∏è Minification JavaScript
        run: |
          echo "üóúÔ∏è Minification des fichiers JavaScript"
          cd optimized
          
          for js_file in *.js; do
            if [ -f "$js_file" ] && [ "$js_file" != "*.js" ]; then
              echo "üìÑ Minification de $js_file"
              original_size=$(stat -c%s "$js_file" 2>/dev/null || stat -f%z "$js_file")
              
              # Sauvegarde de l'original
              cp "$js_file" "${js_file}.original"
              
              # Minification
              terser "$js_file" --compress --mangle --output "$js_file" || {
                echo "‚ö†Ô∏è Erreur lors de la minification de $js_file, restauration de l'original"
                mv "${js_file}.original" "$js_file"
                continue
              }
              
              new_size=$(stat -c%s "$js_file" 2>/dev/null || stat -f%z "$js_file")
              reduction=$((original_size - new_size))
              percentage=$((reduction * 100 / original_size))
              
              echo "‚úÖ $js_file: ${original_size} ‚Üí ${new_size} bytes (-${percentage}%)"
              rm "${js_file}.original"
            fi
          done

      - name: üé® Minification CSS
        run: |
          echo "üé® Minification des fichiers CSS"
          cd optimized
          
          for css_file in *.css; do
            if [ -f "$css_file" ] && [ "$css_file" != "*.css" ]; then
              echo "üìÑ Minification de $css_file"
              original_size=$(stat -c%s "$css_file" 2>/dev/null || stat -f%z "$css_file")
              
              # Sauvegarde de l'original
              cp "$css_file" "${css_file}.original"
              
              # Minification
              csso "$css_file" --output "$css_file" || {
                echo "‚ö†Ô∏è Erreur lors de la minification de $css_file, restauration de l'original"
                mv "${css_file}.original" "$css_file"
                continue
              }
              
              new_size=$(stat -c%s "$css_file" 2>/dev/null || stat -f%z "$css_file")
              reduction=$((original_size - new_size))
              percentage=$((reduction * 100 / original_size))
              
              echo "‚úÖ $css_file: ${original_size} ‚Üí ${new_size} bytes (-${percentage}%)"
              rm "${css_file}.original"
            fi
          done

      - name: üìù Minification HTML
        run: |
          echo "üìù Minification des fichiers HTML"
          cd optimized
          
          for html_file in *.html; do
            if [ -f "$html_file" ] && [ "$html_file" != "*.html" ]; then
              echo "üìÑ Minification de $html_file"
              original_size=$(stat -c%s "$html_file" 2>/dev/null || stat -f%z "$html_file")
              
              # Sauvegarde de l'original
              cp "$html_file" "${html_file}.original"
              
              # Minification HTML avec pr√©servation des fonctionnalit√©s
              html-minifier-terser \
                --collapse-whitespace \
                --remove-comments \
                --remove-optional-tags \
                --remove-redundant-attributes \
                --remove-script-type-attributes \
                --remove-tag-whitespace \
                --use-short-doctype \
                --minify-css true \
                --minify-js true \
                "$html_file" -o "$html_file" || {
                echo "‚ö†Ô∏è Erreur lors de la minification de $html_file, restauration de l'original"
                mv "${html_file}.original" "$html_file"
                continue
              }
              
              new_size=$(stat -c%s "$html_file" 2>/dev/null || stat -f%z "$html_file")
              reduction=$((original_size - new_size))
              percentage=$((reduction * 100 / original_size))
              
              echo "‚úÖ $html_file: ${original_size} ‚Üí ${new_size} bytes (-${percentage}%)"
              rm "${html_file}.original"
            fi
          done

      - name: üñºÔ∏è Optimisation des images
        run: |
          echo "üñºÔ∏è Optimisation des images"
          cd optimized
          
          # Optimisation des PNG
          for png_file in *.png **/*.png; do
            if [ -f "$png_file" ]; then
              echo "üì∏ Optimisation de $png_file"
              original_size=$(stat -c%s "$png_file" 2>/dev/null || stat -f%z "$png_file")
              
              optipng -o2 "$png_file" 2>/dev/null || echo "‚ö†Ô∏è Impossible d'optimiser $png_file"
              
              new_size=$(stat -c%s "$png_file" 2>/dev/null || stat -f%z "$png_file")
              if [ $new_size -lt $original_size ]; then
                reduction=$((original_size - new_size))
                percentage=$((reduction * 100 / original_size))
                echo "‚úÖ $png_file: ${original_size} ‚Üí ${new_size} bytes (-${percentage}%)"
              fi
            fi
          done
          
          # Optimisation des JPEG
          for jpg_file in *.jpg *.jpeg **/*.jpg **/*.jpeg; do
            if [ -f "$jpg_file" ]; then
              echo "üì∏ Optimisation de $jpg_file"
              original_size=$(stat -c%s "$jpg_file" 2>/dev/null || stat -f%z "$jpg_file")
              
              jpegoptim --max=85 "$jpg_file" 2>/dev/null || echo "‚ö†Ô∏è Impossible d'optimiser $jpg_file"
              
              new_size=$(stat -c%s "$jpg_file" 2>/dev/null || stat -f%z "$jpg_file")
              if [ $new_size -lt $original_size ]; then
                reduction=$((original_size - new_size))
                percentage=$((reduction * 100 / original_size))
                echo "‚úÖ $jpg_file: ${original_size} ‚Üí ${new_size} bytes (-${percentage}%)"
              fi
            fi
          done

      - name: üìä G√©n√©ration du rapport d'optimisation
        run: |
          echo "üìä G√©n√©ration du rapport d'optimisation"
          cd optimized
          
          cat > optimization-report.md << EOF
          # üìä Rapport d'Optimisation des Assets
          
          **Date**: $(date)
          **Commit**: ${{ github.sha }}
          
          ## üìà R√©sultats de l'Optimisation
          
          ### üìÅ Fichiers Trait√©s
          
          #### JavaScript
          $(find . -name "*.js" -type f | wc -l) fichiers JavaScript optimis√©s
          
          #### CSS
          $(find . -name "*.css" -type f | wc -l) fichiers CSS optimis√©s
          
          #### HTML
          $(find . -name "*.html" -type f | wc -l) fichiers HTML optimis√©s
          
          #### Images
          - PNG: $(find . -name "*.png" -type f | wc -l) fichiers
          - JPEG: $(find . -name "*.jpg" -o -name "*.jpeg" -type f | wc -l) fichiers
          
          ### üìè Taille Totale du Projet
          **Apr√®s optimisation**: $(du -sh . | cut -f1)
          
          ### üöÄ Recommandations
          
          - ‚úÖ Assets minifi√©s et optimis√©s
          - ‚úÖ Images compress√©es
          - ‚úÖ Code pr√™t pour la production
          
          ### üìã Prochaines √âtapes
          
          1. V√©rifier que l'application fonctionne correctement
          2. Tester les performances en production
          3. Monitorer la taille des assets lors des futures mises √† jour
          
          ---
          *Rapport g√©n√©r√© automatiquement*
          EOF
          
          echo "‚úÖ Rapport d'optimisation g√©n√©r√©"

      - name: üß™ Test de fonctionnalit√© apr√®s optimisation
        run: |
          echo "üß™ Test de fonctionnalit√© apr√®s optimisation"
          cd optimized
          
          # D√©marrage du serveur de test
          python3 -m http.server 8080 &
          SERVER_PID=$!
          sleep 5
          
          # Tests de base
          echo "üîç Test de chargement de la page"
          curl -f http://localhost:8080/ || {
            echo "‚ùå Erreur: La page ne se charge pas apr√®s optimisation"
            kill $SERVER_PID
            exit 1
          }
          
          echo "üîç Test de chargement des scripts"
          curl -f http://localhost:8080/script.js || {
            echo "‚ùå Erreur: script.js ne se charge pas apr√®s optimisation"
            kill $SERVER_PID
            exit 1
          }
          
          echo "üîç Test de chargement des styles"
          curl -f http://localhost:8080/styles.css || {
            echo "‚ùå Erreur: styles.css ne se charge pas apr√®s optimisation"
            kill $SERVER_PID
            exit 1
          }
          
          echo "‚úÖ Tous les tests de fonctionnalit√© pass√©s"
          kill $SERVER_PID

      - name: üì§ Upload des assets optimis√©s
        uses: actions/upload-artifact@v4
        with:
          name: optimized-assets
          path: optimized/
          retention-days: 30

      - name: üì§ Upload du rapport d'optimisation
        uses: actions/upload-artifact@v4
        with:
          name: optimization-report
          path: optimized/optimization-report.md
          retention-days: 30

  cache-optimization:
    name: üóÑÔ∏è Optimisation du Cache
    runs-on: ubuntu-latest
    needs: asset-optimization
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üì• T√©l√©chargement des assets optimis√©s
        uses: actions/download-artifact@v4
        with:
          name: optimized-assets
          path: optimized/

      - name: üóÑÔ∏è Configuration du cache
        run: |
          echo "üóÑÔ∏è Configuration des en-t√™tes de cache"
          cd optimized
          
          # Cr√©ation d'un fichier .htaccess pour Apache (si utilis√©)
          cat > .htaccess << 'EOF'
          # Configuration du cache pour les assets statiques
          <IfModule mod_expires.c>
              ExpiresActive on
              
              # Images
              ExpiresByType image/png "access plus 1 year"
              ExpiresByType image/jpg "access plus 1 year"
              ExpiresByType image/jpeg "access plus 1 year"
              ExpiresByType image/gif "access plus 1 year"
              ExpiresByType image/svg+xml "access plus 1 year"
              
              # CSS et JavaScript
              ExpiresByType text/css "access plus 1 month"
              ExpiresByType application/javascript "access plus 1 month"
              ExpiresByType text/javascript "access plus 1 month"
              
              # HTML
              ExpiresByType text/html "access plus 1 hour"
          </IfModule>
          
          # Compression gzip
          <IfModule mod_deflate.c>
              AddOutputFilterByType DEFLATE text/plain
              AddOutputFilterByType DEFLATE text/html
              AddOutputFilterByType DEFLATE text/xml
              AddOutputFilterByType DEFLATE text/css
              AddOutputFilterByType DEFLATE application/xml
              AddOutputFilterByType DEFLATE application/xhtml+xml
              AddOutputFilterByType DEFLATE application/rss+xml
              AddOutputFilterByType DEFLATE application/javascript
              AddOutputFilterByType DEFLATE application/x-javascript
          </IfModule>
          EOF
          
          echo "‚úÖ Configuration du cache cr√©√©e"

      - name: üì§ Upload de la configuration finale
        uses: actions/upload-artifact@v4
        with:
          name: production-ready-assets
          path: optimized/
          retention-days: 90

  notification:
    name: üìß Notification d'Optimisation
    runs-on: ubuntu-latest
    needs: [asset-optimization, cache-optimization]
    if: always()
    steps:
      - name: üìß R√©sum√© de l'optimisation
        run: |
          echo "üìß R√©sum√© de l'optimisation des assets"
          
          OPTIMIZATION_STATUS="${{ needs.asset-optimization.result }}"
          CACHE_STATUS="${{ needs.cache-optimization.result }}"
          
          echo "üì¶ Optimisation des assets: $OPTIMIZATION_STATUS"
          echo "üóÑÔ∏è Configuration du cache: $CACHE_STATUS"
          
          if [[ "$OPTIMIZATION_STATUS" == "success" && "$CACHE_STATUS" == "success" ]]; then
            echo "‚úÖ Optimisation compl√®te r√©ussie!"
            echo "üöÄ Les assets sont pr√™ts pour la production"
            echo "üìä Consultez les artifacts pour les rapports d√©taill√©s"
          else
            echo "‚ö†Ô∏è Probl√®me lors de l'optimisation"
            echo "üîç V√©rifiez les logs pour plus de d√©tails"
          fi