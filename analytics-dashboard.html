<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Tableau de Bord Analytics</title>
    <!-- Version: 2024-07-08-17:53 - Sans donn√©es simul√©es -->
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-dashboard {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-color, #f8fafc);
            min-height: 100vh;
        }
        
        .dashboard-header {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color, #1a202c);
            margin-bottom: 0.5rem;
        }
        
        .dashboard-subtitle {
            color: var(--text-secondary, #64748b);
            font-size: 1.1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.sessions { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.conversions { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-icon.engagement { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color, #1a202c);
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            color: var(--text-secondary, #64748b);
            font-size: 0.9rem;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color, #1a202c);
            margin-bottom: 1rem;
        }
        
        .heatmap-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            margin-bottom: 2rem;
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 4px;
            margin-top: 1rem;
        }
        
        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            background: #f1f5f9;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        .heatmap-cell.hot-1 { background: #fef3c7; }
        .heatmap-cell.hot-2 { background: #fde68a; }
        .heatmap-cell.hot-3 { background: #fcd34d; }
        .heatmap-cell.hot-4 { background: #f59e0b; }
        .heatmap-cell.hot-5 { background: #d97706; }
        .heatmap-cell.hot-6 { background: #b45309; }
        .heatmap-cell.hot-7 { background: #92400e; }
        .heatmap-cell.hot-8 { background: #78350f; }
        .heatmap-cell.hot-9 { background: #451a03; }
        
        .user-journey {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }
        
        .journey-step {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: #f8fafc;
            border-left: 4px solid #e2e8f0;
        }
        
        .journey-step.active {
            background: #eff6ff;
            border-left-color: #3b82f6;
        }
        
        .journey-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: #64748b;
        }
        
        .journey-step.active .journey-icon {
            background: #3b82f6;
            color: white;
        }
        
        .journey-content {
            flex: 1;
        }
        
        .journey-title {
            font-weight: 600;
            color: var(--text-color, #1a202c);
            margin-bottom: 0.25rem;
        }
        
        .journey-description {
            color: var(--text-secondary, #64748b);
            font-size: 0.9rem;
        }
        
        .journey-metric {
            font-weight: 600;
            color: #3b82f6;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }
        
        .data-table {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .table th {
            font-weight: 600;
            color: var(--text-color, #1a202c);
            background: #f8fafc;
        }
        
        .table td {
            color: var(--text-secondary, #64748b);
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .analytics-dashboard {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="analytics-dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <i class="fas fa-chart-line"></i>
                Tableau de Bord Analytics
            </h1>
            <p class="dashboard-subtitle">Suivi des activit√©s utilisateur et analyse du parcours</p>
        </div>
        
        <!-- Statistiques principales -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon users">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">Utilisateurs uniques</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon sessions">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <div class="stat-value" id="totalSessions">0</div>
                <div class="stat-label">Sessions totales</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon conversions">
                        <i class="fas fa-download"></i>
                    </div>
                </div>
                <div class="stat-value" id="totalConversions">0</div>
                <div class="stat-label">Conversions</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon engagement">
                        <i class="fas fa-mouse-pointer"></i>
                    </div>
                </div>
                <div class="stat-value" id="avgEngagement">0%</div>
                <div class="stat-label">Taux d'engagement</div>
            </div>
        </div>
        
        <!-- Graphiques -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3 class="chart-title">Activit√© au fil du temps</h3>
                <canvas id="activityChart" width="400" height="200"></canvas>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">R√©partition des actions</h3>
                <canvas id="actionsChart" width="300" height="200"></canvas>
            </div>
        </div>
        
        <!-- Heatmap des clics -->
        <div class="heatmap-container">
            <h3 class="chart-title">Carte de chaleur des clics</h3>
            <div class="heatmap-grid" id="heatmapGrid">
                <!-- G√©n√©r√© dynamiquement -->
            </div>
        </div>
        
        <!-- Parcours utilisateur -->
        <div class="user-journey">
            <h3 class="chart-title">Parcours utilisateur type</h3>
            <div id="journeySteps">
                <!-- G√©n√©r√© dynamiquement -->
            </div>
        </div>
        
        <!-- Tableau des donn√©es r√©centes -->
        <div class="data-table">
            <h3 class="chart-title">Activit√©s r√©centes</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Horodatage</th>
                        <th>Action</th>
                        <th>√âl√©ment</th>
                        <th>Donn√©es</th>
                        <th>Session</th>
                    </tr>
                </thead>
                <tbody id="recentActivities">
                    <!-- G√©n√©r√© dynamiquement -->
                </tbody>
            </table>
        </div>
    </div>
    
    <button class="refresh-btn" onclick="refreshDashboard()" title="Actualiser les donn√©es">
        <i class="fas fa-sync-alt"></i>
    </button>
    
    <script>
        class AnalyticsDashboard {
            constructor() {
                this.data = this.loadAnalyticsData();
                this.charts = {};
            }
            
            loadAnalyticsData() {
                // Charger toutes les sessions analytics depuis localStorage
                const allSessions = [];
                const allEvents = [];
                const allClicks = [];
                const allConversions = [];
                
                // Parcourir toutes les cl√©s localStorage pour trouver les donn√©es analytics
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('analytics_')) {
                        try {
                            const sessionData = JSON.parse(localStorage.getItem(key));
                            if (sessionData && sessionData.sessionId) {
                                // Ajouter la session
                                allSessions.push({
                                    sessionId: sessionData.sessionId,
                                    userId: sessionData.userId,
                                    startTime: sessionData.startTime,
                                    endTime: sessionData.endTime,
                                    duration: sessionData.endTime - sessionData.startTime
                                });
                                
                                // Ajouter les √©v√©nements
                                if (sessionData.userActions) {
                                    sessionData.userActions.forEach(action => {
                                        allEvents.push({
                                            timestamp: action.timestamp,
                                            action: action.type,
                                            element: action.element ? action.element.tagName : null,
                                            data: action,
                                            sessionId: sessionData.sessionId
                                        });
                                    });
                                }
                                
                                // Ajouter les clics depuis heatmapData
                                if (sessionData.heatmapData) {
                                    sessionData.heatmapData.forEach(click => {
                                        allClicks.push({
                                            x: click.x / window.innerWidth,
                                            y: click.y / window.innerHeight,
                                            timestamp: click.timestamp,
                                            sessionId: sessionData.sessionId
                                        });
                                    });
                                }
                                
                                // Ajouter les conversions depuis conversionFunnel
                                if (sessionData.conversionFunnel) {
                                    Object.entries(sessionData.conversionFunnel).forEach(([step, completed]) => {
                                        if (completed) {
                                            allConversions.push({
                                                action: step,
                                                timestamp: sessionData.startTime,
                                                sessionId: sessionData.sessionId
                                            });
                                        }
                                    });
                                }
                            }
                        } catch (error) {
                            console.warn('Erreur lors du chargement des donn√©es analytics:', error);
                        }
                    }
                }
                
                console.log('üìä Donn√©es charg√©es:', {
                    sessions: allSessions.length,
                    events: allEvents.length,
                    clicks: allClicks.length,
                    conversions: allConversions.length
                });
                
                return {
                    sessions: allSessions,
                    events: allEvents,
                    clicks: allClicks,
                    conversions: allConversions
                };
            }
            
            init() {
                this.updateStats();
                this.createCharts();
                this.generateHeatmap();
                this.generateUserJourney();
                this.updateRecentActivities();
            }
            
            updateStats() {
                const { sessions, events, clicks, conversions } = this.data;
                
                // Utilisateurs uniques
                const uniqueUsers = new Set(sessions.map(s => s.userId)).size;
                document.getElementById('totalUsers').textContent = uniqueUsers;
                
                // Sessions totales
                document.getElementById('totalSessions').textContent = sessions.length;
                
                // Conversions
                document.getElementById('totalConversions').textContent = conversions.length;
                
                // Taux d'engagement (sessions avec plus de 3 actions)
                const engagedSessions = sessions.filter(s => {
                    const sessionEvents = events.filter(e => e.sessionId === s.sessionId);
                    return sessionEvents.length > 3;
                }).length;
                
                const engagementRate = sessions.length > 0 ? Math.round((engagedSessions / sessions.length) * 100) : 0;
                document.getElementById('avgEngagement').textContent = engagementRate + '%';
            }
            
            createCharts() {
                this.createActivityChart();
                this.createActionsChart();
            }
            
            createActivityChart() {
                const ctx = document.getElementById('activityChart').getContext('2d');
                const { events } = this.data;
                
                // D√©truire le graphique existant s'il existe
                if (this.charts.activity) {
                    this.charts.activity.destroy();
                }
                
                // Grouper les √©v√©nements par heure
                const hourlyData = new Array(24).fill(0);
                events.forEach(event => {
                    const hour = new Date(event.timestamp).getHours();
                    hourlyData[hour]++;
                });
                
                this.charts.activity = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => i + 'h'),
                        datasets: [{
                            label: 'Activit√©',
                            data: hourlyData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            createActionsChart() {
                const ctx = document.getElementById('actionsChart').getContext('2d');
                const { events } = this.data;
                
                // D√©truire le graphique existant s'il existe
                if (this.charts.actions) {
                    this.charts.actions.destroy();
                }
                
                // Compter les types d'actions
                const actionCounts = {};
                events.forEach(event => {
                    actionCounts[event.action] = (actionCounts[event.action] || 0) + 1;
                });
                
                const labels = Object.keys(actionCounts);
                const data = Object.values(actionCounts);
                const colors = [
                    '#667eea', '#f093fb', '#4facfe', '#43e97b',
                    '#f6d55c', '#ff6b6b', '#4ecdc4', '#45b7d1'
                ];
                
                this.charts.actions = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            generateHeatmap() {
                const { clicks } = this.data;
                const grid = document.getElementById('heatmapGrid');
                grid.innerHTML = '';
                
                // Cr√©er une grille 10x10
                const gridSize = 100;
                const cellCounts = new Array(gridSize).fill(0);
                
                // Distribution r√©elle des clics (sans donn√©es simul√©es)
                clicks.forEach(click => {
                    // Utiliser uniquement les vraies coordonn√©es de clic
                    if (click.x !== undefined && click.y !== undefined) {
                        const x = Math.floor(click.x * 10);
                        const y = Math.floor(click.y * 10);
                        const index = y * 10 + x;
                        if (index >= 0 && index < gridSize) {
                            cellCounts[index]++;
                        }
                    }
                });
                
                const maxCount = Math.max(...cellCounts);
                
                for (let i = 0; i < gridSize; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    
                    if (cellCounts[i] > 0 && maxCount > 0) {
                        const intensity = Math.ceil((cellCounts[i] / maxCount) * 9);
                        cell.classList.add(`hot-${intensity}`);
                    }
                    
                    cell.title = `Clics: ${cellCounts[i]}`;
                    grid.appendChild(cell);
                }
            }
            
            generateUserJourney() {
                const container = document.getElementById('journeySteps');
                const { events, conversions } = this.data;
                
                // D√©finir les √©tapes du parcours
                const journeySteps = [
                    { id: 'page_view', icon: 'fas fa-eye', title: 'Arriv√©e sur le site', description: 'L\'utilisateur visite la page' },
                    { id: 'input_focus', icon: 'fas fa-edit', title: 'Saisie de code', description: 'L\'utilisateur commence √† saisir du code' },
                    { id: 'preset_used', icon: 'fas fa-palette', title: 'Utilisation de preset', description: 'L\'utilisateur s√©lectionne un preset' },
                    { id: 'image_generation_started', icon: 'fas fa-cogs', title: 'G√©n√©ration d\'image', description: 'L\'utilisateur lance la conversion' },
                    { id: 'image_downloaded', icon: 'fas fa-download', title: 'T√©l√©chargement', description: 'L\'utilisateur t√©l√©charge l\'image' }
                ];
                
                container.innerHTML = '';
                
                journeySteps.forEach((step, index) => {
                    const stepEvents = events.filter(e => e.action === step.id);
                    const stepConversions = conversions.filter(c => c.action === step.id);
                    const count = stepEvents.length + stepConversions.length;
                    
                    const stepElement = document.createElement('div');
                    stepElement.className = `journey-step ${count > 0 ? 'active' : ''}`;
                    
                    stepElement.innerHTML = `
                        <div class="journey-icon">
                            <i class="${step.icon}"></i>
                        </div>
                        <div class="journey-content">
                            <div class="journey-title">${step.title}</div>
                            <div class="journey-description">${step.description}</div>
                        </div>
                        <div class="journey-metric">${count}</div>
                    `;
                    
                    container.appendChild(stepElement);
                });
            }
            
            updateRecentActivities() {
                const { events, conversions } = this.data;
                const tbody = document.getElementById('recentActivities');
                
                // Combiner et trier les √©v√©nements
                const allEvents = [...events, ...conversions]
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .slice(0, 20);
                
                tbody.innerHTML = '';
                
                allEvents.forEach(event => {
                    const row = document.createElement('tr');
                    const timestamp = new Date(event.timestamp).toLocaleString('fr-FR');
                    const data = event.data ? JSON.stringify(event.data) : '-';
                    
                    row.innerHTML = `
                        <td>${timestamp}</td>
                        <td>${event.action}</td>
                        <td>${event.element || '-'}</td>
                        <td>${data}</td>
                        <td>${event.sessionId.substring(0, 8)}...</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
            
            refresh() {
                // D√©truire les anciens graphiques AVANT de les recr√©er
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                this.charts = {};
                
                this.data = this.loadAnalyticsData();
                this.init();
            }
        }
        
        // Initialiser le tableau de bord
        let dashboard;
        
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new AnalyticsDashboard();
            dashboard.init();
            
            // Auto-refresh toutes les 30 secondes
            setInterval(() => {
                dashboard.refresh();
            }, 30000);
        });
        
        function refreshDashboard() {
            if (dashboard) {
                dashboard.refresh();
                
                // Animation du bouton
                const btn = document.querySelector('.refresh-btn i');
                btn.style.animation = 'spin 1s linear';
                setTimeout(() => {
                    btn.style.animation = '';
                }, 1000);
            }
        }
        
        // Animation de rotation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>